{% extends "base.html" %}
{% block content %}
<h4>异常详情 #{{ ex.event_id }}</h4>

<div class="card p-3">
  <div>发生时间：{{ ex.occurred_time }}</div>
  <div>类型：{{ ex.exception_type }}</div>
  <div>罚款：{{ ex.fine_amount }}</div>
  <div>状态：<b>{{ ex.status }}</b></div>
  <div>描述：{{ ex.description }}</div>

  <hr/>
  <div>关联运单：#{{ ex.order_id }}（{{ ex.destination }}，运单状态：{{ ex.order_status }}）</div>
  <div>车辆：{{ ex.license_plate_number }}（车辆状态：{{ ex.vehicle_status }}）</div>
  <div>司机：{{ ex.driver_name }}（ID {{ ex.driver_id }}）</div>

  {% if user.role == 'supervisor' %}
    <form class="mt-2" method="post" action="{{ url_for('exception_update_status', event_id=ex.event_id) }}">
      <label class="form-label">更新异常处理状态</label>
      <select class="form-select" name="status">
        {% for s in ['待处理','处理中','已处理'] %}
          <option value="{{ s }}" {% if ex.status==s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
      <button class="btn btn-primary mt-2" type="submit">提交</button>
      <div class="text-muted small">说明：若改为“已处理”，数据库触发器将写审计日志并按异常类型恢复车辆状态。</div>
    </form>
  {% endif %}
</div>
{% endblock %}

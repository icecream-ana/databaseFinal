# 索引的设置策略（FleetDB 物流管理系统）

> 本文档基于项目实际实现的 `indexes.sql`，并结合已实现的存储过程与视图（`procedures.sql` / `views.sql`）分析每个索引的**目的**、**覆盖的查询路径**与**字段顺序的设计原因**。

---

## 1. 索引设计目标

FleetDB 的核心高频查询主要围绕：
- 运单的时间窗口统计（按月报、按时间段绩效）
- 司机/车辆维度的聚合分析
- 异常事件的时间窗口告警（近 7 天、近 30 天）
- 组织层级联查（车辆→车队→中心）

因此索引策略的总体目标是：

1. **减少时间过滤的扫描范围**：对 `created_at`、`occurred_time` 建立索引，确保“近 N 天 / 某月”查询优先走 Index Seek。
2. **加速常见维度统计**：对 `driver_id / vehicle_id` 与时间字段组成复合索引，支持“按人/按车 + 时间段”的统计。
3. **优化多表 JOIN 的连接键**：对外键字段（`vehicle_id`、`fleet_id`、`center_id`、`order_id`）建立索引，减少 JOIN 代价。
4. **在性能与写入成本之间平衡**：仅为已出现的高频访问路径建立必要索引，避免冗余。

---

## 2. 已实现索引清单（indexes.sql）

项目中实际创建的索引如下（按表归类）：

### 2.1 运单表 `orders`
1. `IX_orders_created_at`：`orders(created_at)`
2. `IX_orders_driver_created_at`：`orders(driver_id, created_at)`
3. `IX_orders_vehicle_created_at`：`orders(vehicle_id, created_at)`

### 2.2 异常事件表 `exception_events`
1. `IX_exception_events_occurred_time`：`exception_events(occurred_time)`
2. `IX_exception_events_order_id`：`exception_events(order_id)`

### 2.3 组织层级表（JOIN 加速）
1. `IX_vehicles_fleet_id`：`vehicles(fleet_id)`
2. `IX_fleets_center_id`：`fleets(center_id)`

---

## 3. 每个索引的设计动机与覆盖查询路径

> 这里按“它解决什么查询”来解释（老师/助教最爱看这种写法）。

### 3.1 `IX_orders_created_at`（按时间窗口统计的基础索引）
**索引字段**：`orders(created_at)`

**主要支持**：
- `sp_fleet_monthly_report` 中对运单的月度时间窗口过滤：
  - `o.created_at >= @start AND o.created_at < @end`
- `sp_driver_performance` 中对司机运单的时间窗口过滤：
  - `o.created_at >= @start AND o.created_at < @end`

**设计原因**：
- 时间是最常见的过滤维度。没有索引时，数据库往往需要扫描大范围记录才能筛出指定月份/时间段。
- 建立时间索引后，查询更容易走 **Index Seek**，显著减少 I/O。

---

### 3.2 `IX_orders_driver_created_at`（司机绩效统计的“人+时间”复合索引）
**索引字段**：`orders(driver_id, created_at)`

**主要支持**：
- `sp_driver_performance`：核心过滤条件就是 `driver_id` + `created_at` 时间窗
  - `WHERE driver_id=@driver_id AND created_at BETWEEN ...`

**字段顺序为什么是 `(driver_id, created_at)`？**
- 该过程通常是“指定一个司机，再查时间段”，因此 `driver_id` 的选择性更强、过滤更先发生。
- 将 `driver_id` 放在索引前缀，可以让 SQL Server 先定位该司机的记录范围，再在这个范围内按 `created_at` 做区间查找。

---

### 3.3 `IX_orders_vehicle_created_at`（车辆利用/车队统计的“车+时间”复合索引）
**索引字段**：`orders(vehicle_id, created_at)`

**主要支持**：
- `sp_fleet_monthly_report` 中，车队统计通过 `orders` JOIN `vehicles` 再按时间筛选；统计时常会涉及车辆维度（例如活跃车辆数、空闲车辆数）。
- 视图 `vw_abnormal_driver_vehicle_alert` 的 CTE `e30`：
  - `orders o` 与 `exception_events e` 按 `order_id` 关联，但核心聚合维度包含 `vehicle_id`，并且 `e` 被限制在近 30 天。

**设计原因**：
- 车辆维度的查询/聚合在“车队管理”场景中非常常见。
- 复合索引能够加速“按车过滤/聚合 + 时间范围”类访问模式。

---

### 3.4 `IX_exception_events_occurred_time`（异常告警视图的关键索引）
**索引字段**：`exception_events(occurred_time)`

**主要支持**：
- `vw_weekly_exception_alert`：
  - `WHERE e.occurred_time >= DATEADD(DAY, -7, ...)`
- `vw_abnormal_driver_vehicle_alert`：
  - 在 CTE `e30` 中限制近 30 天异常：`e.occurred_time >= DATEADD(DAY, -30, GETDATE())`

**设计原因**：
- “近 7 天/近 30 天”属于典型时间窗筛选。异常表随时间增长较快，若无索引会导致频繁全表扫描。

---

### 3.5 `IX_exception_events_order_id`（异常 → 运单关联的连接索引）
**索引字段**：`exception_events(order_id)`

**主要支持**：
- `vw_weekly_exception_alert`：`exception_events e JOIN orders o ON o.order_id = e.order_id`
- `sp_driver_performance`：`exception_events e ON e.order_id = o.order_id`
- `sp_fleet_monthly_report` 的 CTE `fleet_exceptions`：异常事件通过 `order_id` 与当月运单集合关联

**设计原因**：
- 异常事件表通常通过 `order_id` 回溯运单。对连接键建索引可降低 JOIN 成本，提高联查效率。

---

### 3.6 `IX_vehicles_fleet_id` 与 `IX_fleets_center_id`（组织层级联查加速）
**索引字段**：
- `vehicles(fleet_id)`
- `fleets(center_id)`

**主要支持**：
- 所有包含组织层级联查的视图与统计：
  - `orders -> vehicles -> fleets -> centers`
- `vw_weekly_exception_alert` 中的链路 JOIN：
  - `vehicles v JOIN fleets f ON f.fleet_id = v.fleet_id`
  - `fleets f JOIN centers c ON c.center_id = f.center_id`

**设计原因**：
- 组织层级是典型维度表连接链。对外键列建立索引，可以让多表 JOIN 更稳定地走索引路径。

---

## 4. 与业务功能的对应关系（总结表）

| 功能/对象 | 关键过滤/连接字段 | 对应索引 | 作用 |
|---|---|---|---|
| 车队月报 `sp_fleet_monthly_report` | `orders.created_at`, `vehicles.fleet_id`, `exception_events.order_id`, `exception_events.occurred_time` | `IX_orders_created_at`, `IX_vehicles_fleet_id`, `IX_exception_events_order_id`, `IX_exception_events_occurred_time` | 时间窗筛选 + 车队维度联查 + 异常关联 |
| 司机绩效 `sp_driver_performance` | `orders.driver_id + created_at`, `exception_events.order_id` | `IX_orders_driver_created_at`, `IX_exception_events_order_id` | 快速定位某司机在时间段内的运单与异常 |
| 近 7 天异常告警视图 | `exception_events.occurred_time`, `order_id` 以及组织链路外键 | `IX_exception_events_occurred_time`, `IX_exception_events_order_id`, `IX_vehicles_fleet_id`, `IX_fleets_center_id` | 近时窗告警查询更快 |
| 近 30 天预警视图 | `exception_events.occurred_time`, `orders.vehicle_id`（聚合维度） | `IX_exception_events_occurred_time`, `IX_orders_vehicle_created_at` | 支撑 30 天异常聚合统计 |

---

## 5. 代价与取舍

1. **写入成本增加**：`orders` 与 `exception_events` 在插入/更新时需要维护索引，写入开销上升。
2. **存储空间占用**：索引会额外占用磁盘空间，尤其时间字段/复合索引在大表上增长较快。
3. **避免冗余**：本项目的索引选择紧扣已实现的过程/视图访问路径，不盲目堆叠。
